<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Parking Status</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .status-card {
            transition: all 0.3s ease;
        }
        .status-AVAILABLE {
            border-left: 5px solid #28a745;
        }
        .status-LIMITED {
            border-left: 5px solid #ffc107;
        }
        .status-FULL {
            border-left: 5px solid #dc3545;
        }
        .space-number {
            font-size: 2.5rem;
            font-weight: bold;
        }
        .vehicle-type {
            font-size: 1.2rem;
            font-weight: bold;
        }
        .update-animation {
            animation: flash 1s;
        }
        .parking-visualization {
            position: relative;
            width: 100%;
            height: 300px;
            border: 1px solid #ddd;
            margin-top: 1rem;
        }
        .vehicle-marker {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #007bff;
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }
        @keyframes flash {
            0% { background-color: #fff; }
            50% { background-color: #e9ecef; }
            100% { background-color: #fff; }
        }
    </style>
</head>
    
<body>
    <div class="container py-4">
        <header class="pb-3 mb-4 border-bottom">
            <h1 class="display-5 fw-bold">AmazonPark</h1>
        </header>

        <div class="row">
            <div class="col-md-8">
                <!-- Main Status Card -->
             <div class="status-card card shadow-sm mb-4" id="mainStatus">
    <div class="card-body">
        <div class="row">
            <div class="col-md-4 text-center mb-3">
                <div class="space-number" id="availableSpaces">--</div>
                <div class="text-muted">Available Spaces</div>
            </div>
            <div class="col-md-4 text-center mb-3">
                <div class="space-number" id="occupiedSpaces">--</div>
                <div class="text-muted">Occupied Spaces</div>
            </div>
            <div class="col-md-4 text-center mb-3">
                <div class="space-number" id="occupancyRate">--%</div>
                <div class="text-muted">Occupancy Rate</div>
            </div>
        </div>
        <div class="progress mb-3">
            <div class="progress-bar" id="occupancyBar" role="progressbar" style="width: 0%"></div>
        </div>
        <div class="text-muted small">
            Last updated: <span id="lastUpdated">--</span>
        </div>
        <!-- Add this line right here -->
        <div class="text-muted small">
            Data stored locally: <span id="dataStorageTime">--</span>
        </div>
    </div>
</div>

                <!-- Vehicle Analysis Card -->
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Vehicle Analysis</h5>
                        <div class="row" id="vehicleTypes">
                            <!-- Vehicle types will be inserted here -->
                        </div>
                        <div id="parkingVisualization" class="parking-visualization">
                            <!-- Vehicle markers will be inserted here -->
                        </div>
                    </div>
                </div>
<div class="card shadow-sm mb-4">
    <div class="card-body">
        <h5 class="card-title">Parking Reservation</h5>
        <div id="reservationError" class="alert alert-danger" style="display:none;"></div>
        
        <!-- Reservation Form -->
        <form id="reservationForm" class="mb-3">
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">Start Time</label>
                    <input type="datetime-local" class="form-control" id="startTime" required>
                </div>
                <div class="col-md-6">
                    <label class="form-label">End Time</label>
                    <input type="datetime-local" class="form-control" id="endTime" required>
                </div>
                <div class="col-12">
                    <button type="submit" class="btn btn-primary">Make Reservation</button>
                </div>
            </div>
        </form>

        <!-- My Reservations -->
        <h6 class="mt-4">My Reservations</h6>
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Start Time</th>
                        <th>End Time</th>
                        <th>Spot</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="reservationsTable">
                </tbody>
            </table>
        </div>
    </div>
</div>

                <!-- Historical Analysis Card -->
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Historical Analysis</h5>
                        <div id="chartError" class="alert alert-danger" style="display:none;"></div>
                        <div class="btn-group mb-3">
                            <button class="btn btn-outline-primary" onclick="loadHistoricalData('daily')">Daily</button>
                            <button class="btn btn-outline-primary" onclick="loadHistoricalData('weekly')">Weekly</button>
                            <button class="btn btn-outline-primary" onclick="loadHistoricalData('monthly')">Monthly</button>
                        </div>
                        <div id="peakInfo" class="mb-2"></div>
                        <canvas id="occupancyChart"></canvas>
                       </div>
                </div>

                <!-- Time Analysis Card -->
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Time Analysis</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <p>Time of Day: <span id="timeOfDay">--</span></p>
                                <p>Peak Hours: <span id="peakHours" class="badge">--</span></p>
                            </div>
                            <div class="col-md-6">
                                <p>Day of Week: <span id="dayOfWeek">--</span></p>
                                <p>Average Occupancy: <span id="avgOccupancy">--%</span></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- History Table Card -->
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">Status History</h5>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Time</th>
                                        <th>Available</th>
                                        <th>Occupied</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="historyTable">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        <div class="col-md-4">
                <!-- Connection Status Card -->
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Connection Status</h5>
                        <div id="connectionStatus" class="alert alert-secondary">
                            Connecting...
                        </div>
                        <button class="btn btn-primary btn-sm" onclick="manualReconnect()">
                            Reconnect
                        </button>
                    </div>
                </div>

                <!-- Analysis Details Card -->
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">Analysis Details</h5>
                        <div id="analysisDetails">
                            <p>Parking Lot Detection: <span id="isParkingLot" class="badge">--</span></p>
                            <p>Outdoor Detection: <span id="isOutdoor" class="badge">--</span></p>
                            <p>Average Confidence: <span id="avgConfidence">--%</span></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

   <script>
    let socket;
    let isConnecting = false;
    let reconnectAttempts = 0;
    const MAX_RECONNECT_ATTEMPTS = 5;
    let history = [];
    const MAX_HISTORY = 10;
    let occupancyChart;

    const API_ENDPOINT = 'https://7rw5ezddjj.execute-api.us-east-1.amazonaws.com/prod';

    const STORAGE_KEYS = {
        HISTORY: 'parkingHistory',
        CURRENT_STATUS: 'parkingCurrentStatus',
        LAST_CHART_TYPE: 'lastChartType'
    };

    function saveToLocalStorage(key, data) {
        try {
            localStorage.setItem(key, JSON.stringify(data));
        } catch (error) {
            console.error('Error saving to localStorage:', error);
        }
    }

    function loadFromLocalStorage(key) {
        try {
            const data = localStorage.getItem(key);
            return data ? JSON.parse(data) : null;
        } catch (error) {
            console.error('Error loading from localStorage:', error);
            return null;
        }
    }

    function connect() {
        if (isConnecting) return;
        isConnecting = true;
        
        const connectionStatus = document.getElementById('connectionStatus');
        connectionStatus.className = 'alert alert-secondary';
        connectionStatus.textContent = 'Connecting...';

        socket = new WebSocket('wss://bt7t18tvag.execute-api.us-east-1.amazonaws.com/production');

        socket.onopen = () => {
            isConnecting = false;
            reconnectAttempts = 0;
            connectionStatus.className = 'alert alert-success';
            connectionStatus.textContent = 'Connected';
        };

        socket.onclose = () => {
            isConnecting = false;
            connectionStatus.className = 'alert alert-warning';
            connectionStatus.textContent = 'Disconnected - Attempting to reconnect...';
            
            if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                reconnectAttempts++;
                setTimeout(connect, 2000);
            } else {
                connectionStatus.className = 'alert alert-danger';
                connectionStatus.textContent = 'Connection failed - Please refresh the page';
            }
        };

        socket.onerror = (error) => {
            isConnecting = false;
            connectionStatus.className = 'alert alert-danger';
            connectionStatus.textContent = 'Connection error - Will attempt to reconnect';
            console.error('WebSocket error:', error);
        };

        socket.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                console.log('Received data:', data);
                if (data.availableSpaces !== undefined) {
                    updateStatus(data);
                    addToHistory(data);
                }
            } catch (error) {
                console.error('Error processing message:', error);
            }
        };
    }

    function startHeartbeat() {
        setInterval(() => {
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({ action: 'heartbeat' }));
            }
        }, 30000);
    }

    function monitorConnection() {
        setInterval(() => {
            if (socket && socket.readyState !== WebSocket.OPEN && !isConnecting) {
                connect();
            }
        }, 5000);
    }

    function manualReconnect() {
        reconnectAttempts = 0;
        history = []; // Clear history
        if (socket) {
            socket.close();
        }
        connect();
    }

    function updateStatus(data) {
        const maimainStatus = document.getElementById('mainStatus');
        mainStatus.className = `status-card card shadow-sm mb-4 status-${data.parkingStatus}`;
        
        document.getElementById('availableSpaces').textContent = data.availableSpaces;
        document.getElementById('occupiedSpaces').textContent = data.occupiedSpaces;
        document.getElementById('occupancyRate').textContent = `${data.occupancyRate}%`;
        
        const bar = document.getElementById('occupancyBar');
        bar.style.width = `${data.occupancyRate}%`;
        
        if (data.occupancyRate < 70) {
            bar.className = 'progress-bar bg-success';
        } else if (data.occupancyRate < 90) {
            bar.className = 'progress-bar bg-warning';
        } else {
            bar.className = 'progress-bar bg-danger';
        }

        document.getElementById('lastUpdated').textContent = new Date(data.lastUpdated).toLocaleString();
        
        mainStatus.classList.add('update-animation');
        setTimeout(() => mainStatus.classList.remove('update-animation'), 1000);

        // Save current status
        saveToLocalStorage(STORAGE_KEYS.CURRENT_STATUS, data);
           updateDataStorageTime();
    }

    function addToHistory(data) {
        try {
            if (!data.lastUpdated || !data.availableSpaces || !data.occupiedSpaces || !data.parkingStatus) {
                console.error('Invalid data received:', data);
                return;
            }

            const time = new Date(data.lastUpdated).toLocaleTimeString();
            
            if (time !== 'Invalid Date') {
                history.unshift({
                    time: time,
                    available: data.availableSpaces,
                    occupied: data.occupiedSpaces,
                    status: data.parkingStatus
                });

                if (history.length > MAX_HISTORY) {
                    history.pop();
                }

                // Save history to localStorage
                saveToLocalStorage(STORAGE_KEYS.HISTORY, history);

                updateHistoryTable();
            }
        } catch (error) {
            console.error('Error adding to history:', error);
        }
    }

    function updateHistoryTable() {
        const tbody = document.getElementById('historyTable');
        if (tbody) {
            tbody.innerHTML = history
                .filter(entry => entry.time && entry.available && entry.occupied && entry.status)
                .map(entry => `
                    <tr>
                        <td>${entry.time}</td>
                        <td>${entry.available}</td>
                        <td>${entry.occupied}</td>
                        <td><span class="badge bg-${entry.status === 'AVAILABLE' ? 'success' : entry.status === 'LIMITED' ? 'warning' : 'danger'}">${entry.status}</span></td>
                    </tr>
                `).join('');
        }
    }

    async function loadHistoricalData(timeframe) {
        try {
            saveToLocalStorage(STORAGE_KEYS.LAST_CHART_TYPE, timeframe);
            const response = await fetch(`${API_ENDPOINT}/historical?type=${timeframe}`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            updateChart(data, timeframe);
        } catch (error) {
            console.error('Error loading historical data:', error);
            const chartError = document.getElementById('chartError');
            if (chartError) {
                chartError.textContent = `Failed to load historical data: ${error.message}`;
                chartError.style.display = 'block';
            }
        }
    }

    function updateChart(data, timeframe) {
        const ctx = document.getElementById('occupancyChart').getContext('2d');
        
        if (occupancyChart) {
            occupancyChart.destroy();
        }
        
        const labels = timeframe === 'daily' 
            ? Array.from({length: 24}, (_, i) => `${i}:00`)
            : ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        
        const chartData = timeframe === 'daily' ? data.hourly : data.daily;
        
        occupancyChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Average Occupancy Rate',
                    data: labels.map(label => {
                        const key = timeframe === 'daily' ? label.split(':')[0] : labels.indexOf(label).toString();
                        return chartData[key] || 0;
                    }),
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        title: {
                            display: true,
                            text: 'Occupancy Rate (%)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: timeframe === 'daily' ? 'Hour of Day' : 'Day of Week'
                        }
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: `Parking Occupancy - ${timeframe.charAt(0).toUpperCase() + timeframe.slice(1)} View`
                    }
                }
            }
        });

        // Update peak time information if available
        if (data.peak) {
            const peakInfo = document.getElementById('peakInfo');
            if (peakInfo) {
                peakInfo.textContent = `Peak: ${data.peak.peak.toFixed(2)}%, Off-Peak: ${data.peak.offPeak.toFixed(2)}%`;
            }
        }

        // Save chart data
        saveToLocalStorage(`chartData_${timeframe}`, data);
        updateDataStorageTime();
    }

    function initializeFromStorage() {
        // Load and display history
        const savedHistory = loadFromLocalStorage(STORAGE_KEYS.HISTORY);
        if (savedHistory) {
            history = savedHistory;
            updateHistoryTable();
        }

        // Load and display current status
        const savedStatus = loadFromLocalStorage(STORAGE_KEYS.CURRENT_STATUS);
        if (savedStatus) {
            updateStatus(savedStatus);
        }

        // Load last selected chart timeframe
        const lastChartType = loadFromLocalStorage(STORAGE_KEYS.LAST_CHART_TYPE) || 'daily';
        loadHistoricalData(lastChartType);

        updateDataStorageTime();
    }

    function cleanupStorageData() {
        const ONE_DAY = 24 * 60 * 60 * 1000; // milliseconds
        const now = new Date().getTime();
        
        Object.keys(localStorage).forEach(key => {
            if (key.startsWith('chartData_')) {
                const data = loadFromLocalStorage(key);
                if (data && data.lastUpdated) {
                    const dataAge = now - new Date(data.lastUpdated).getTime();
                    if (dataAge > ONE_DAY) {
                        localStorage.removeItem(key);
                    }
                }
            }
        });
    }

    function updateDataStorageTime() {
        const storageTimeElement = document.getElementById('dataStorageTime');
        if (storageTimeElement) {
            const lastUpdated = loadFromLocalStorage(STORAGE_KEYS.CURRENT_STATUS)?.lastUpdated;
            if (lastUpdated) {
                const storedTime = new Date(lastUpdated);
                storageTimeElement.textContent = storedTime.toLocaleString();
            } else {
                storageTimeElement.textContent = 'No data stored';
            }
        }
    }
       function initializeReservationSystem() {
    // Set min datetime for reservation inputs
    const now = new Date();
    const minDateTime = now.toISOString().slice(0, 16); // Format: YYYY-MM-DDTHH:mm
    
    document.getElementById('startTime').min = minDateTime;
    document.getElementById('endTime').min = minDateTime;
    
    // Add form submit handler
    document.getElementById('reservationForm').addEventListener('submit', handleReservationSubmit);
    
    // Load existing reservations
    loadUserReservations();
}

async function handleReservationSubmit(event) {
    event.preventDefault();
    
    const startTime = document.getElementById('startTime').value;
    const endTime = document.getElementById('endTime').value;
    
    try {
        const response = await fetch(`${API_ENDPOINT}/reservations`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                startTime,
                endTime
            })
        });
        
        if (!response.ok) {
            throw new Error('Failed to create reservation');
        }
        
        const reservation = await response.json();
        document.getElementById('reservationForm').reset();
        loadUserReservations();
        
    } catch (error) {
        const errorElement = document.getElementById('reservationError');
        errorElement.textContent = error.message;
        errorElement.style.display = 'block';
    }
}

async function loadUserReservations() {
    try {
        const response = await fetch(`${API_ENDPOINT}/reservations`);
        if (!response.ok) {
            throw new Error('Failed to load reservations');
        }
        
        const reservations = await response.json();
        updateReservationsTable(reservations);
        
    } catch (error) {
        console.error('Error loading reservations:', error);
    }
}

function updateReservationsTable(reservations) {
    const tbody = document.getElementById('reservationsTable');
    tbody.innerHTML = reservations
        .sort((a, b) => new Date(a.startTime) - new Date(b.startTime))
        .map(reservation => `
            <tr>
                <td>${new Date(reservation.startTime).toLocaleString()}</td>
                <td>${new Date(reservation.endTime).toLocaleString()}</td>
                <td>${reservation.spotNumber}</td>
                <td>
                    <span class="badge bg-${getStatusColor(reservation.status)}">
                        ${reservation.status}
                    </span>
                </td>
                <td>
                    ${reservation.status === 'CONFIRMED' ? 
                        `<button class="btn btn-sm btn-danger" onclick="cancelReservation('${reservation.reservationId}')">
                            Cancel
                        </button>` : 
                        ''}
                </td>
            </tr>
        `).join('');
}

function getStatusColor(status) {
    switch (status) {
        case 'CONFIRMED': return 'success';
        case 'PENDING': return 'warning';
        case 'CANCELLED': return 'danger';
        case 'COMPLETED': return 'info';
        default: return 'secondary';
    }
}

async function cancelReservation(reservationId) {
    try {
        const response = await fetch(`${API_ENDPOINT}/reservations/${reservationId}`, {
            method: 'DELETE'
        });
        
        if (!response.ok) {
            throw new Error('Failed to cancel reservation');
        }
        
        loadUserReservations();
        
    } catch (error) {
        console.error('Error cancelling reservation:', error);
    }
}

    // Initialize everything when page loads
    window.addEventListener('load', () => {
    initializeFromStorage();
    connect();
    startHeartbeat();
    monitorConnection();
    initializeReservationSystem();  // Add this line
});


    // Handle page unload/close
    window.addEventListener('beforeunload', () => {
        if (socket && socket.readyState === WebSocket.OPEN) {
            socket.close();
        }
    });

    // Periodic cleanup
    setInterval(cleanupStorageData, 60 * 60 * 1000); // every hour
</script>
</body>
</html>

    
