<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Parking Status</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Keep your existing styles */
    </style>
</head>
<body>
    <div class="container py-4">
        <header class="pb-3 mb-4 border-bottom">
            <h1 class="display-5 fw-bold">Smart Parking Status</h1>
        </header>

        <div class="row">
            <div class="col-md-8">
                <div class="status-card card shadow-sm mb-4" id="mainStatus">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 text-center mb-3">
                                <div class="space-number" id="availableSpaces">--</div>
                                <div class="text-muted">Available Spaces</div>
                            </div>
                            <div class="col-md-4 text-center mb-3">
                                <div class="space-number" id="occupiedSpaces">--</div>
                                <div class="text-muted">Occupied Spaces</div>
                            </div>
                            <div class="col-md-4 text-center mb-3">
                                <div class="space-number" id="occupancyRate">--%</div>
                                <div class="text-muted">Occupancy Rate</div>
                            </div>
                        </div>
                        <div class="progress mb-3">
                            <div class="progress-bar" id="occupancyBar" role="progressbar" style="width: 0%"></div>
                        </div>
                        <div class="text-muted small">
                            Last updated: <span id="lastUpdated">--</span>
                        </div>
                    </div>
                </div>

                <!-- Add History Table -->
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">Status History</h5>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Time</th>
                                        <th>Available</th>
                                        <th>Occupied</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="historyTable">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">Connection Status</h5>
                        <div id="connectionStatus" class="alert alert-secondary">
                            Connecting...
                        </div>
                        <button class="btn btn-primary btn-sm" onclick="manualReconnect()">
                            Reconnect
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let socket;
        let isConnecting = false;
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 5;
        let history = [];
        const MAX_HISTORY = 10;

        function connect() {
            if (isConnecting) return;
            isConnecting = true;
            
            const connectionStatus = document.getElementById('connectionStatus');
            connectionStatus.className = 'alert alert-secondary';
            connectionStatus.textContent = 'Connecting...';

            socket = new WebSocket('wss://bt7t18tvag.execute-api.us-east-1.amazonaws.com/production');

            socket.onopen = () => {
                isConnecting = false;
                reconnectAttempts = 0;
                connectionStatus.className = 'alert alert-success';
                connectionStatus.textContent = 'Connected';
            };

            socket.onclose = () => {
                isConnecting = false;
                connectionStatus.className = 'alert alert-warning';
                connectionStatus.textContent = 'Disconnected - Attempting to reconnect...';
                
                if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                    reconnectAttempts++;
                    setTimeout(connect, 2000);
                } else {
                    connectionStatus.className = 'alert alert-danger';
                    connectionStatus.textContent = 'Connection failed - Please refresh the page';
                }
            };

            socket.onerror = (error) => {
                isConnecting = false;
                connectionStatus.className = 'alert alert-danger';
                connectionStatus.textContent = 'Connection error - Will attempt to reconnect';
                console.error('WebSocket error:', error);
            };

            socket.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    updateStatus(data);
                    addToHistory(data);
                } catch (error) {
                    console.error('Error processing message:', error);
                }
            };
        }

        function startHeartbeat() {
            setInterval(() => {
                if (socket && socket.readyState === WebSocket.OPEN) {
                    socket.send(JSON.stringify({ action: 'heartbeat' }));
                }
            }, 30000);
        }

        function monitorConnection() {
            setInterval(() => {
                if (socket && socket.readyState !== WebSocket.OPEN && !isConnecting) {
                    connect();
                }
            }, 5000);
        }

        function manualReconnect() {
            reconnectAttempts = 0;
            if (socket) {
                socket.close();
            }
            connect();
        }

        function updateStatus(data) {
            const mainStatus = document.getElementById('mainStatus');
            mainStatus.className = `status-card card shadow-sm mb-4 status-${data.parkingStatus}`;
            
            document.getElementById('availableSpaces').textContent = data.availableSpaces;
            document.getElementById('occupiedSpaces').textContent = data.occupiedSpaces;
            document.getElementById('occupancyRate').textContent = `${data.occupancyRate}%`;
            
            const bar = document.getElementById('occupancyBar');
            bar.style.width = `${data.occupancyRate}%`;
            
            if (data.occupancyRate < 70) {
                bar.className = 'progress-bar bg-success';
            } else if (data.occupancyRate < 90) {
                bar.className = 'progress-bar bg-warning';
            } else {
                bar.className = 'progress-bar bg-danger';
            }

            document.getElementById('lastUpdated').textContent = new Date(data.lastUpdated).toLocaleString();
            
            mainStatus.classList.add('update-animation');
            setTimeout(() => mainStatus.classList.remove('update-animation'), 1000);
        }

        function addToHistory(data) {
            const time = new Date(data.lastUpdated).toLocaleTimeString();
            history.unshift({
                time,
                available: data.availableSpaces,
                occupied: data.occupiedSpaces,
                status: data.parkingStatus
            });

            if (history.length > MAX_HISTORY) {
                history.pop();
            }

            const tbody = document.getElementById('historyTable');
            tbody.innerHTML = history.map(entry => `
                <tr>
                    <td>${entry.time}</td>
                    <td>${entry.available}</td>
                    <td>${entry.occupied}</td>
                    <td><span class="badge bg-${entry.status === 'AVAILABLE' ? 'success' : entry.status === 'LIMITED' ? 'warning' : 'danger'}">${entry.status}</span></td>
                </tr>
            `).join('');
        }

        // Initialize everything when page loads
        window.addEventListener('load', () => {
            connect();
            startHeartbeat();
            monitorConnection();
        });
    </script>
</body>
</html>
    
