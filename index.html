<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Parking Status</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .status-card {
            transition: all 0.3s ease;
        }
        .status-AVAILABLE {
            border-left: 5px solid #28a745;
        }
        .status-LIMITED {
            border-left: 5px solid #ffc107;
        }
        .status-FULL {
            border-left: 5px solid #dc3545;
        }
        .space-number {
            font-size: 2.5rem;
            font-weight: bold;
        }
        .vehicle-type {
            font-size: 1.2rem;
            font-weight: bold;
        }
        .update-animation {
            animation: flash 1s;
        }
        .parking-visualization {
            position: relative;
            width: 100%;
            height: 300px;
            border: 1px solid #ddd;
            margin-top: 1rem;
        }
        .vehicle-marker {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #007bff;
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }
        @keyframes flash {
            0% { background-color: #fff; }
            50% { background-color: #e9ecef; }
            100% { background-color: #fff; }
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <header class="pb-3 mb-4 border-bottom">
            <h1 class="display-5 fw-bold">AmazonPark</h1>
        </header>

        <div class="row">
            <div class="col-md-8">
                <div class="status-card card shadow-sm mb-4" id="mainStatus">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 text-center mb-3">
                                <div class="space-number" id="availableSpaces">--</div>
                                <div class="text-muted">Available Spaces</div>
                            </div>
                            <div class="col-md-4 text-center mb-3">
                                <div class="space-number" id="occupiedSpaces">--</div>
                                <div class="text-muted">Occupied Spaces</div>
                            </div>
                            <div class="col-md-4 text-center mb-3">
                                <div class="space-number" id="occupancyRate">--%</div>
                                <div class="text-muted">Occupancy Rate</div>
                            </div>
                        </div>
                        <div class="progress mb-3">
                            <div class="progress-bar" id="occupancyBar" role="progressbar" style="width: 0%"></div>
                        </div>
                        <div class="text-muted small">
                            Last updated: <span id="lastUpdated">--</span>
                        </div>
                    </div>
                </div>

                <!-- Vehicle Type Analysis -->
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Vehicle Analysis</h5>
                        <div class="row" id="vehicleTypes">
                            <!-- Vehicle types will be inserted here -->
                        </div>
                        <div id="parkingVisualization" class="parking-visualization">
                            <!-- Vehicle markers will be inserted here -->
                        </div>
                    </div>
                </div>
                
    <!-- Historical Data -->
<div class="card shadow-sm mb-4">
    <div class="card-body">
        <h5 class="card-title">Historical Analysis</h5>
        <div class="btn-group mb-3">
            <button class="btn btn-outline-primary" onclick="loadHistoricalData('daily')">Daily</button>
            <button class="btn btn-outline-primary" onclick="loadHistoricalData('weekly')">Weekly</button>
            <button class="btn btn-outline-primary" onclick="loadHistoricalData('monthly')">Monthly</button>
        </div>
        <canvas id="occupancyChart"></canvas>
    </div>
</div>
                <!-- Time Analysis -->
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Time Analysis</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <p>Time of Day: <span id="timeOfDay">--</span></p>
                                <p>Peak Hours: <span id="peakHours" class="badge">--</span></p>
                            </div>
                            <div class="col-md-6">
                                <p>Day of Week: <span id="dayOfWeek">--</span></p>
                                <p>Average Occupancy: <span id="avgOccupancy">--%</span></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- History Table -->
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">Status History</h5>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Time</th>
                                        <th>Available</th>
                                        <th>Occupied</th>
                                        <th>Status</th>
                                        <th>Details</th>
                                    </tr>
                                </thead>
                                <tbody id="historyTable">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Connection Status</h5>
                        <div id="connectionStatus" class="alert alert-secondary">
                            Connecting...
                        </div>
                        <button class="btn btn-primary btn-sm" onclick="manualReconnect()">
                            Reconnect
                        </button>
                    </div>
                </div>

                <!-- Analysis Details -->
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">Analysis Details</h5>
                        <div id="analysisDetails">
                            <p>Parking Lot Detection: <span id="isParkingLot" class="badge">--</span></p>
                            <p>Outdoor Detection: <span id="isOutdoor" class="badge">--</span></p>
                            <p>Average Confidence: <span id="avgConfidence">--%</span></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    let socket;
    let isConnecting = false;
    let reconnectAttempts = 0;
    const MAX_RECONNECT_ATTEMPTS = 5;
    let history = [];
    const MAX_HISTORY = 10;

    function connect() {
        if (isConnecting) return;
        isConnecting = true;
        
        const connectionStatus = document.getElementById('connectionStatus');
        connectionStatus.className = 'alert alert-secondary';
        connectionStatus.textContent = 'Connecting...';

        socket = new WebSocket('wss://bt7t18tvag.execute-api.us-east-1.amazonaws.com/production');

        socket.onopen = () => {
            isConnecting = false;
            reconnectAttempts = 0;
            connectionStatus.className = 'alert alert-success';
            connectionStatus.textContent = 'Connected';
        };

        socket.onclose = () => {
            isConnecting = false;
            connectionStatus.className = 'alert alert-warning';
            connectionStatus.textContent = 'Disconnected - Attempting to reconnect...';
            
            if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                reconnectAttempts++;
                setTimeout(connect, 2000);
            } else {
                connectionStatus.className = 'alert alert-danger';
                connectionStatus.textContent = 'Connection failed - Please refresh the page';
            }
        };

        socket.onerror = (error) => {
            isConnecting = false;
            connectionStatus.className = 'alert alert-danger';
            connectionStatus.textContent = 'Connection error - Will attempt to reconnect';
            console.error('WebSocket error:', error);
        };

        socket.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                console.log('Received data:', data);
                if (data.availableSpaces !== undefined) {
                    updateStatus(data);
                    addToHistory(data);
                }
            } catch (error) {
                console.error('Error processing message:', error);
            }
        };
    }

    function startHeartbeat() {
        setInterval(() => {
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({ action: 'heartbeat' }));
            }
        }, 30000);
    }

    function monitorConnection() {
        setInterval(() => {
            if (socket && socket.readyState !== WebSocket.OPEN && !isConnecting) {
                connect();
            }
        }, 5000);
    }

    function manualReconnect() {
        reconnectAttempts = 0;
        history = []; // Clear history
        if (socket) {
            socket.close();
        }
        connect();
    }

    function updateStatus(data) {
        const mainStatus = document.getElementById('mainStatus');
        mainStatus.className = `status-card card shadow-sm mb-4 status-${data.parkingStatus}`;
        
        document.getElementById('availableSpaces').textContent = data.availableSpaces;
        document.getElementById('occupiedSpaces').textContent = data.occupiedSpaces;
        document.getElementById('occupancyRate').textContent = `${data.occupancyRate}%`;
        
        const bar = document.getElementById('occupancyBar');
        bar.style.width = `${data.occupancyRate}%`;
        
        if (data.occupancyRate < 70) {
            bar.className = 'progress-bar bg-success';
        } else if (data.occupancyRate < 90) {
            bar.className = 'progress-bar bg-warning';
        } else {
            bar.className = 'progress-bar bg-danger';
        }

        document.getElementById('lastUpdated').textContent = new Date(data.lastUpdated).toLocaleString();
        
        mainStatus.classList.add('update-animation');
        setTimeout(() => mainStatus.classList.remove('update-animation'), 1000);
    }

    function addToHistory(data) {
        try {
            // Validate data before adding to history
            if (!data.lastUpdated || !data.availableSpaces || !data.occupiedSpaces || !data.parkingStatus) {
                console.error('Invalid data received:', data);
                return;
            }

            const time = new Date(data.lastUpdated).toLocaleTimeString();
            
            // Only add to history if we have valid data
            if (time !== 'Invalid Date') {
                history.unshift({
                    time: time,
                    available: data.availableSpaces,
                    occupied: data.occupiedSpaces,
                    status: data.parkingStatus
                });

                if (history.length > MAX_HISTORY) {
                    history.pop();
                }

                const tbody = document.getElementById('historyTable');
                tbody.innerHTML = history
                    .filter(entry => entry.time && entry.available && entry.occupied && entry.status)
                    .map(entry => `
                        <tr>
                            <td>${entry.time}</td>
                            <td>${entry.available}</td>
                            <td>${entry.occupied}</td>
                            <td><span class="badge bg-${entry.status === 'AVAILABLE' ? 'success' : entry.status === 'LIMITED' ? 'warning' : 'danger'}">${entry.status}</span></td>
                        </tr>
                    `).join('');
            }
        } catch (error) {
            console.error('Error adding to history:', error);
        }
    }

    // Initialize everything when page loads
   
        // Initialize everything when page loads
        window.addEventListener('load', () => {
            connect();
            startHeartbeat();
            monitorConnection();
        });

        // Handle page unload/close
        window.addEventListener('beforeunload', () => {
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.close();
            }
        });
        
        script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

let occupancyChart;

const API_ENDPOINT = 'https://7rw5ezddjj.execute-api.us-east-1.amazonaws.com/prod';

async function loadHistoricalData(timeframe) {
    try {
        const response = await fetch(`${API_ENDPOINT}/historical?type=${timeframe}`);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        updateChart(data, timeframe);
    } catch (error) {
        console.error('Error loading historical data:', error);
        // Optional: Show error to user
        document.getElementById('chartError')?.textContent = 
            `Failed to load historical data: ${error.message}`;
    }
}

function updateChart(data, timeframe) {
    const ctx = document.getElementById('occupancyChart').getContext('2d');
    
    if (occupancyChart) {
        occupancyChart.destroy();
    }
    
    const labels = timeframe === 'daily' 
        ? Array.from({length: 24}, (_, i) => `${i}:00`)
        : ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    
    const chartData = timeframe === 'daily' ? data.hourly : data.daily;
    
    occupancyChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Average Occupancy Rate',
                data: labels.map(label => chartData[timeframe === 'daily' 
                    ? parseInt(label) 
                    : labels.indexOf(label)] || 0),
                borderColor: 'rgb(75, 192, 192)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });
}

// Load daily data by default
document.addEventListener('DOMContentLoaded', () => {
    loadHistoricalData('daily');
});


    </script>
</body>
</html>
    
